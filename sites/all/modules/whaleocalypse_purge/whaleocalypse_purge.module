<?php

function whaleocalypse_purge_database_cache($urls) {
	foreach ($urls as $url) {
		$url = $url . '/';
		$ka = db_delete('cache_page')
  		->condition('cid', $url)
  		->execute();
	}
}

function whaleocalypse_purge_varnish_cache($varnish_urls) {
	foreach ($varnish_urls as $url) {
			$curl = curl_init($url);
			curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "PURGE");
			curl_exec($curl);
		}
	}

function whaleocalypse_purge_comment_insert($comment) {
	global $base_url;
	$nid = $comment->nid;

	$_url_parts = parse_url($base_url);
	$naked_url = $_url_parts['scheme'] . '://' . $_url_parts['host'];
	
	$urls = array();
	
	$urls[] = $varnish_urls[] = $naked_url . '/node/' . $nid;
	$urls[] = $varnish_urls[] = $naked_url . '/' . drupal_get_path_alias('node/' . $nid);
	$urls[] = $naked_url . ':8000/node/' . $nid;
	$urls[] = $naked_url . ':8000/' . drupal_get_path_alias('node/' . $nid);

	$current_front_page = views_get_view_result('main', 'single_node_page_1');
	if ($current_front_page[0]->nid && $current_front_page[0]->nid == $nid) {
		$urls[] = $varnish_urls[] = $naked_url;
		$urls[] = $varnish_urls[] = $naked_url . '/main';
		$urls[] = $naked_url . ':8000';
		$urls[] = $naked_url . ':8000/main';
	}
	
	whaleocalypse_purge_database_cache($urls);
	whaleocalypse_purge_varnish_cache($varnish_urls);
	$rand = substr(md5(microtime()),rand(0,26),5);
	$goto = $base_url . '/' . drupal_get_path_alias('node/' . $nid) . '?' . $rand . '#comment-' . $comment->cid;
	drupal_goto($goto, array(), 302);
}